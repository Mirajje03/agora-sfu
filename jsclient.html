<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Unified Join Client</title>
  <style>
    body { font-family: monospace; max-width: 800px; margin: 2em auto; background: #f4f4f9; }
    .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    button { padding: 10px 20px; background: #28a745; color: white; border: none; cursor: pointer; font-size: 16px; }
    button:disabled { background: #ccc; }
    #logs { background: #222; color: #0f0; padding: 10px; height: 300px; overflow-y: auto; border-radius: 4px; margin-top:10px;}
    .badge { background: #007bff; color: white; padding: 5px 10px; border-radius: 15px; margin: 5px; display: inline-block; }
  </style>
</head>
<body>

<div class="container">
  <h1>ðŸš€ Unified Join Client</h1>
  <p>Microphone is sent in the Initial Offer (No Phase 2 Upload).</p>

  <div style="margin-bottom: 20px;">
    <input id="wsurl" value="ws://127.0.0.1:8000" placeholder="WS URL">
    <input id="roomid" value="1001" size="5" placeholder="Room">
    <button id="connect">Get Mic & Join</button>
  </div>
  
  <div id="remotes"></div>
  <pre id="logs"></pre>
</div>

<script>
let pc, ws;

function log(msg) {
    const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
    console.log(line);
    document.getElementById("logs").textContent += line + "\n";
    document.getElementById("logs").scrollTop = 99999;
}

document.getElementById("connect").onclick = async () => {
  const url = document.getElementById("wsurl").value;
  document.getElementById("connect").disabled = true;

  try {
      log("ðŸŽ¤ 1. Requesting Microphone...");
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      log("âœ… Microphone Acquired.");

      // Start the connection process with the stream ready
      startConnection(url, stream);

  } catch (e) {
      log("âŒ Error: " + e.message);
      document.getElementById("connect").disabled = false;
  }
};

function startConnection(url, localStream) {
  ws = new WebSocket(url);

  ws.onopen = () => {
    log("ðŸ”µ 2. WebSocket Connected");
    
    // RTCPeerConnection configuration with STUN server
    const config = {
        iceServers: [
            { urls: "stun:stun.l.google.com:19302" }
        ]
    };
    pc = new RTCPeerConnection(config);

    // --- STEP A: Add Mic Track BEFORE Offer ---
    localStream.getTracks().forEach(track => {
        log(`âž• Added Mic Track to PC (ID: ${track.id.substring(0,5)}...)`);
        pc.addTrack(track, localStream);
    });

    // --- STEP B: Add Data Channel (Required) ---
    pc.createDataChannel("control");

    // --- STEP C: Handle Incoming Audio (From Server) ---
    pc.ontrack = (e) => {
        const id = e.track.id;
        log(`ðŸŽ§ NEW REMOTE AUDIO (User: ${id.substring(0,5)}...)`);
        
        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.innerHTML = `User ${id.substring(0,5)}... ðŸ”Š`;
        
        const au = document.createElement('audio');
        au.srcObject = e.streams[0];
        au.autoplay = true;
        badge.appendChild(au);
        document.getElementById("remotes").appendChild(badge);
    };

    // --- STEP D: Trigger Single Initial Offer ---
    pc.onnegotiationneeded = async () => {
        // This will only run ONCE because we add tracks before this event fires/processes
        log("âš™ï¸ Generating Initial Offer (Contains MIC + DATA)...");
        
        const offer = await pc.createOffer();
        
        // Verify for debugging
        if (offer.sdp.includes("m=audio")) {
            log("â„¹ï¸ Verified: Offer contains Audio Media Section.");
        }

        await pc.setLocalDescription(offer);

        ws.send(JSON.stringify({
            type: "offer",
            room_id: document.getElementById("roomid").value,
            sdp: pc.localDescription.sdp
        }));
        
        log("ðŸ“¤ Sent Initial Offer to Server.");
    };

    // --- ICE Handling ---
    pc.onicecandidate = ({candidate}) => {
        if (candidate && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: "candidate", candidate: candidate.candidate, sdpMid: candidate.sdpMid }));
        }
    };

    pc.onconnectionstatechange = () => {
        log(`PC State: ${pc.connectionState.toUpperCase()}`);
    };
  };

  ws.onmessage = async (msg) => {
    const data = JSON.parse(msg.data);

    if (data.type === "answer") {
      log("ðŸ“© Received ANSWER. (Upload Established)");
      await pc.setRemoteDescription(data);
    } 
    else if (data.type === "offer") {
      // This handles the Server sending DOWNLINK tracks (other people)
      log("ðŸ“© Received SERVER OFFER (Incoming Room Audio).");
      
      await pc.setRemoteDescription(data);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      
      ws.send(JSON.stringify({ type: "answer", sdp: answer.sdp }));
      log("ðŸ“¤ Sent Answer to Server.");
    } 
    else if (data.type === "candidate") {
      if (pc.remoteDescription) await pc.addIceCandidate(data);
    }
  };
}
</script>
</body>
</html>
